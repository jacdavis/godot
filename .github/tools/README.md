# Build Performance Analysis Tools

This directory contains tools used by the GitHub Actions workflows to analyze build performance.

## BuildInsights.EtlToJson.exe

This tool converts ETL (Event Trace Log) files generated by `vcperf` into JSON format for easier analysis and storage.

### Usage

```powershell
BuildInsights.EtlToJson.exe <etl-file-path> [output-json-path]
```

- `<etl-file-path>`: Path to the input ETL file (required)
- `[output-json-path]`: Path for the output JSON file (optional, defaults to same name as ETL with .json extension)

### Example

```powershell
BuildInsights.EtlToJson.exe BuildTrace.etl BuildTrace.json
```

### Output

The tool uses `BuildInsightsAnalyzer.GetSummarizedAnalysis()` from the BuildPerformance library to extract:
- Top 15 most expensive functions
- Top 15 most expensive files
- Top 15 most expensive templates
- Include tree analysis
- Build duration

### Updating the Tool

**IMPORTANT**: The BuildPerformance library uses Central Package Management. You MUST update the System.Text.Json version in `Directory.Packages.props` to 8.0.5 before building, otherwise the tool will reference v9.0.0 which is not compatible with GitHub Actions runners.

To rebuild and update this tool:

1. Update the package version in BuildPerformance:
   ```powershell
   # Edit Q:\src\BuildPerformance\Microsoft.BuildInsights.Library\Directory.Packages.props
   # Change: <PackageVersion Include="System.Text.Json" Version="9.0.0" />
   # To:     <PackageVersion Include="System.Text.Json" Version="8.0.5" />
   ```

2. Navigate to the tool directory:
   ```powershell
   cd Q:\src\BuildPerformance\BuildInsights.EtlToJson
   ```

3. Build and publish:
   ```powershell
   Remove-Item -Recurse -Force publish-output -ErrorAction SilentlyContinue
   dotnet publish -c Release -r win-x64 --self-contained true -o publish-output --framework net8.0
   ```

4. Copy the published files to the armemulator repository:
   ```powershell
   Get-ChildItem "Q:\src\armemulator\.github\tools\" -File | Remove-Item -Force
   Get-ChildItem "Q:\src\armemulator\.github\tools\" -Directory | Remove-Item -Recurse -Force
   Copy-Item ".\publish-output\*" -Destination "Q:\src\armemulator\.github\tools\" -Recurse -Force
   ```

5. Recreate this README file and commit the updated binaries.

6. **Don't forget to revert the Directory.Packages.props change** if it's needed for other projects.

### Source Code

The source code for this tool is located at:
`Q:\src\BuildPerformance\BuildInsights.EtlToJson\`

The underlying analysis library is at:
`Q:\src\BuildPerformance\Microsoft.BuildInsights.Library\`
